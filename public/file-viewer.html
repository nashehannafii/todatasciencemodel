<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>File Viewer</title>
  <style>
    :root { 
      --bg:#fafbfc; --card:#ffffff; --text:#1e293b; --text-muted:#64748b; 
      --border:#e2e8f0; --accent:#4f46e5; --accent-hover:#4338ca;
      --shadow: 0 1px 3px rgba(0,0,0,0.05); --shadow-lg: 0 4px 16px rgba(0,0,0,0.08);
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body {
      min-height:100vh; background:var(--bg); color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',sans-serif;
      line-height:1.6;
    }
    .navbar {
      background:var(--card); border-bottom:1px solid var(--border);
      padding:16px 24px; display:flex; justify-content:space-between; align-items:center;
      box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
    }
    .brand { font-weight:700; letter-spacing:-0.01em; }
    .menu { display:flex; gap:14px; align-items:center; }
    .menu a { color:var(--text); text-decoration:none; font-weight:500; font-size:14px; }
    .menu a:hover { color:var(--accent-hover); }
    .title { font-size:18px; font-weight:600; }
    .actions { display:flex; gap:12px; }
    .btn {
      padding:8px 16px; border-radius:6px; text-decoration:none; font-size:14px;
      font-weight:500; transition:all 0.2s; display:inline-flex; align-items:center;
      border:1px solid var(--border);
    }
    .btn-primary { background:var(--accent); color:white; border-color:var(--accent); }
    .btn-primary:hover { background:var(--accent-hover); }
    .btn-secondary { background:transparent; color:var(--accent); }
    .btn-secondary:hover { background:var(--accent); color:white; }
    .viewer {
      width:100%; height:calc(100vh - 70px); display:flex; align-items:center;
      justify-content:center; padding:24px; overflow:auto;
    }
    .viewer iframe {
      width:100%; height:100%; border:1px solid var(--border);
      border-radius:8px; box-shadow:var(--shadow-lg); background:white;
    }
    .viewer img {
      max-width:100%; max-height:100%; border-radius:8px;
      box-shadow:var(--shadow-lg); object-fit:contain;
    }
    .loading { color:var(--text-muted); font-size:14px; }
    .error { color:#ef4444; padding:20px; }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="brand">Patient Data</div>
    <nav class="menu">
      <a href="/">Beranda</a>
      <a href="/patient-form">Input Pasien</a>
      <a href="/patients-view">Data Pasien</a>
    </nav>
    <div class="actions">
      <a href="#" id="downloadBtn" class="btn btn-primary">⬇ Unduh</a>
      <a href="#" id="backBtn" class="btn btn-secondary">← Kembali</a>
    </div>
  </header>
  <div class="viewer" id="viewer">
    <div class="loading">Memuat file...</div>
  </div>

  <script>
    const params = new URLSearchParams(location.search);
    const patientId = params.get('patientId');
    const episodeId = params.get('episodeId');
    const stageId = params.get('stageId');
    const fileId = params.get('fileId');
    const fileName = params.get('fileName') || 'File';
    const contentType = params.get('contentType') || '';

    document.getElementById('fileName').textContent = fileName;
    
    if (!patientId || !episodeId || !stageId || !fileId) {
      document.getElementById('viewer').innerHTML = '<div class="error">Parameter tidak lengkap</div>';
    } else {
      const viewUrl = `/patients/${patientId}/episodes/${episodeId}/stages/${stageId}/files/${fileId}`;
      const downloadUrl = `${viewUrl}/download`;
      
      document.getElementById('downloadBtn').href = downloadUrl;
      document.getElementById('backBtn').href = `/patient-detail?id=${patientId}`;

      const viewer = document.getElementById('viewer');
      viewer.innerHTML = '';

      if (contentType.includes('pdf') || fileName.toLowerCase().endsWith('.pdf')) {
        // PDF viewer
        const iframe = document.createElement('iframe');
        iframe.src = viewUrl;
        iframe.onload = () => console.log('PDF loaded');
        iframe.onerror = () => {
          viewer.innerHTML = '<div class="error">Gagal memuat PDF. <a href="'+downloadUrl+'">Unduh file</a></div>';
        };
        viewer.appendChild(iframe);
      } else if (contentType.includes('image') || /\.(jpg|jpeg|png|gif)$/i.test(fileName)) {
        // Image viewer
        const img = document.createElement('img');
        img.src = viewUrl;
        img.alt = fileName;
        img.onload = () => console.log('Image loaded');
        img.onerror = () => {
          viewer.innerHTML = '<div class="error">Gagal memuat gambar. <a href="'+downloadUrl+'">Unduh file</a></div>';
        };
        viewer.appendChild(img);
      } else if (fileName.toLowerCase().endsWith('.dcm')) {
        // DICOM files - provide download option
        viewer.innerHTML = `
          <div style="text-align:center">
            <div class="loading">File DICOM tidak dapat ditampilkan di browser.</div>
            <div style="margin-top:16px">
              <a href="${downloadUrl}" class="btn btn-primary">⬇ Unduh file DCM</a>
            </div>
          </div>
        `;
      } else {
        // Unknown type - offer download
        viewer.innerHTML = `
          <div style="text-align:center">
            <div class="loading">Tipe file tidak didukung untuk preview.</div>
            <div style="margin-top:16px">
              <a href="${downloadUrl}" class="btn btn-primary">⬇ Unduh file</a>
            </div>
          </div>
        `;
      }
    }
  </script>
</body>
</html>
