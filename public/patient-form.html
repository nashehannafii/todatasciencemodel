<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Form Input Pasien</title>
  <style>
    :root {
      --bg: #ffffff;
      --card: #ffffff;
      --accent: #000000;
      --accent-hover: #333333;
      --text: #000000;
      --text-light: #666666;
      --text-muted: #999999;
      --danger: #dc3545;
      --success: #28a745;
      --border: #e8e8e8;
      --input-border: #dddddd;
      --shadow: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 0.5px 1px rgba(0,0,0,0.03);
      --fieldset-bg: #fafafa;
    }
    :root.dark {
      --bg: #0a0a0a;
      --card: #141414;
      --accent: #ffffff;
      --accent-hover: #e0e0e0;
      --text: #ffffff;
      --text-light: #b0b0b0;
      --text-muted: #808080;
      --danger: #ff4d4d;
      --success: #4ade80;
      --border: #2a2a2a;
      --input-border: #333333;
      --shadow: 0 1px 2px rgba(255,255,255,0.02);
      --shadow-sm: 0 0.5px 1px rgba(255,255,255,0.01);
      --fieldset-bg: #0f0f0f;
    }
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Inter', sans-serif;
      background: var(--bg); 
      color: var(--text);
      min-height: 100vh; 
      line-height: 1.5;
      font-size: 15px;
    }
    .container { 
      width: 100%; 
      max-width: 680px; 
      padding: 32px 20px; 
      margin: 0 auto; 
    }
    .header {
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
      margin-bottom: 32px;
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border);
    }
    .title { 
      font-size: 24px; 
      font-weight: 600; 
      letter-spacing: -0.02em; 
      color: var(--text);
    }
    .nav a { 
      color: var(--text-light); 
      text-decoration: none; 
      margin-left: 20px; 
      font-size: 14px; 
      transition: color 0.15s;
      font-weight: 400;
    }
    .nav a:hover { color: var(--text); }
    .toggle { 
      cursor: pointer; 
      color: var(--text-muted); 
      margin-left: 20px; 
      font-size: 13px;
      padding: 6px 12px; 
      border-radius: 4px; 
      transition: all 0.15s;
      border: 1px solid var(--border);
      background: transparent;
      font-weight: 400;
    }
    .toggle:hover { 
      background: var(--fieldset-bg); 
      color: var(--text); 
      border-color: var(--input-border); 
    }
    .navbar {
      display: flex; 
      justify-content: space-between; 
      align-items: center;
      padding: 14px 20px; 
      background: var(--card); 
      border-bottom: 1px solid var(--border);
      position: sticky; 
      top: 0; 
      z-index: 10;
      backdrop-filter: blur(8px);
    }
    .brand { 
      font-weight: 600; 
      letter-spacing: -0.01em; 
      font-size: 15px;
      color: var(--text);
    }
    .menu { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
    }
    .menu a { 
      color: var(--text-light); 
      text-decoration: none; 
      font-weight: 400; 
      font-size: 14px; 
    }
    .menu a:hover { color: var(--text); }
    .card {
      background: var(--card); 
      border: 1px solid var(--border);
      border-radius: 6px; 
      padding: 28px; 
      box-shadow: var(--shadow);
    }
    .card > p {
      color: var(--text-light);
      font-size: 14px;
      margin-bottom: 24px;
    }
    form { 
      display: grid; 
      gap: 20px; 
    }
    fieldset {
      border: 1px solid var(--border); 
      border-radius: 6px; 
      padding: 20px; 
      background: var(--fieldset-bg);
    }
    legend { 
      color: var(--text-muted); 
      padding: 0 8px; 
      font-weight: 500; 
      font-size: 13px; 
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    label { 
      display: block; 
      font-weight: 500; 
      margin-bottom: 6px; 
      color: var(--text); 
      font-size: 13px; 
    }
    input, select, textarea {
      width: 100%; 
      padding: 9px 12px; 
      border-radius: 4px;
      border: 1px solid var(--input-border); 
      background: var(--card);
      color: var(--text); 
      outline: none; 
      font-size: 14px;
      transition: border-color 0.15s, box-shadow 0.15s;
      font-family: inherit;
    }
    input:focus, select:focus, textarea:focus { 
      border-color: var(--text); 
      box-shadow: 0 0 0 2px rgba(0,0,0,0.05); 
    }
    :root.dark input:focus, 
    :root.dark select:focus, 
    :root.dark textarea:focus { 
      border-color: var(--text); 
      box-shadow: 0 0 0 2px rgba(255,255,255,0.08); 
    }
    input::placeholder, textarea::placeholder { 
      color: var(--text-muted); 
    }
    .row { 
      display: grid; 
      grid-template-columns: 1fr 1fr; 
      gap: 14px; 
    }
    button {
      padding: 10px 18px; 
      border-radius: 4px; 
      border: 1px solid transparent; 
      cursor: pointer; 
      font-weight: 500; 
      font-size: 14px; 
      transition: all 0.15s;
      font-family: inherit;
    }
    .btn-primary { 
      background: var(--accent); 
      color: var(--bg); 
      border-color: var(--accent);
    }
    .btn-primary:hover { 
      background: var(--accent-hover); 
      border-color: var(--accent-hover);
    }
    .btn-secondary { 
      background: var(--fieldset-bg); 
      color: var(--text); 
      border-color: var(--border);
    }
    .btn-secondary:hover { 
      background: var(--border); 
    }
    .btn-danger { 
      background: var(--danger); 
      color: white; 
    }
    .btn-danger:hover { 
      opacity: 0.85; 
    }
    .btn-link { 
      background: transparent; 
      color: var(--text-light); 
      text-decoration: none; 
      border: none;
      padding: 10px 0;
    }
    .btn-link:hover { 
      color: var(--text); 
    }
    .actions { 
      display: flex; 
      gap: 12px; 
      margin-top: 8px; 
    }
    .success { 
      color: var(--success); 
      font-weight: 500; 
      margin-top: 12px; 
      font-size: 14px;
    }
    .error { 
      color: var(--danger); 
      font-weight: 500; 
      margin-top: 12px; 
      font-size: 14px;
    }
    .stage, .file { 
      border: 1px solid var(--border); 
      border-radius: 4px; 
      padding: 16px; 
      margin: 12px 0; 
      background: var(--card);
    }
    small {
      font-size: 12px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <header class="navbar">
    <div class="brand">Patient Data</div>
    <nav class="menu">
      <a href="/">Beranda</a>
      <a href="/patient-form">Input Pasien</a>
      <a href="/patients-view">Data Pasien</a>
      <span id="themeToggle" class="toggle">Tema: Cerah</span>
    </nav>
  </header>
  <div class="container">
    <div class="header">
      <div class="title">Input Data Pasien</div>
    </div>
    <div class="card">
    <p>Isi data pasien berikut dan klik Simpan.</p>

    <form id="patientForm">
    <div class="row">
      <div>
        <label for="name">Nama</label>
        <input id="name" name="name" value="John Doe" required />
      </div>
      <div>
        <label for="patientId">ID Pasien</label>
        <input id="patientId" name="patientId" value="PAT001" required />
      </div>
    </div>

    <div class="row">
      <div>
        <label for="birthDate">Tanggal Lahir</label>
        <input id="birthDate" name="birthDate" type="date" value="1990-01-15" required />
      </div>
      <div>
        <label for="gender">Jenis Kelamin</label>
        <select id="gender" name="gender" required>
          <option value="">-- pilih --</option>
          <option value="male" selected>Pria</option>
          <option value="female">Wanita</option>
          <option value="other">Lainnya</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label for="phone">No. Telepon</label>
        <input id="phone" name="phone" value="081234567890" required />
      </div>
      <div>
        <label for="email">Email</label>
        <input id="email" name="email" type="email" value="johndoe@email.com" />
      </div>
    </div>

    <div>
      <label for="address">Alamat</label>
      <textarea id="address" name="address" rows="2">Jl. Contoh No. 123, Jakarta</textarea>
    </div>

    <fieldset>
      <legend>Kontak Darurat (opsional)</legend>
      <div class="row">
        <div>
          <label for="emergencyContactName">Nama</label>
          <input id="emergencyContactName" name="emergencyContactName" value="Jane Doe" />
        </div>
        <div>
          <label for="emergencyContactPhone">Telepon</label>
          <input id="emergencyContactPhone" name="emergencyContactPhone" value="081298765432" />
        </div>
      </div>
      <div>
        <label for="emergencyContactRelationship">Hubungan</label>
        <input id="emergencyContactRelationship" name="emergencyContactRelationship" value="Istri" />
      </div>
    </fieldset>

    <fieldset>
      <legend>Episode Perawatan</legend>
      <div id="episodesContainer"></div>
      <button type="button" id="addEpisodeBtn">+ Tambah Episode</button>
    </fieldset>

    <div class="actions">
      <button type="submit" class="btn-primary">Simpan</button>
      <a href="/" class="btn-link">Kembali ke Beranda</a>
    </div>
    <p id="message"></p>
  </form>
  </div>
  </div>

  <script>
    const form = document.getElementById('patientForm');
    const message = document.getElementById('message');

    const episodesContainer = document.getElementById('episodesContainer');
    const addEpisodeBtn = document.getElementById('addEpisodeBtn');

    function createStageElement(epIndex) {
      const stage = document.createElement('div');
      stage.className = 'stage';
      stage.style.border = '1px dashed #ccc';
      stage.style.padding = '8px';
      stage.style.margin = '8px 0';

      stage.innerHTML = `
        <div class="row">
          <div>
            <label>Nama Stage</label>
            <input name="episodes[${epIndex}].stages[].name" value="Pemeriksaan Awal" required />
          </div>
          <div>
            <label>Tanggal (YYYY-MM-DD)</label>
            <input name="episodes[${epIndex}].stages[].date" type="date" value="${new Date().toISOString().split('T')[0]}" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Waktu (HH:MM)</label>
            <input name="episodes[${epIndex}].stages[].time" type="time" value="09:00" required />
          </div>
          <div>
            <label>Ruang Perawatan (Ward)</label>
            <input name="episodes[${epIndex}].stages[].ward" value="Ruang A1" required />
          </div>
        </div>
        <div>
          <label>Status</label>
          <select name="episodes[${epIndex}].stages[].status" required>
            <option value="">-- pilih --</option>
            <option value="pending">Pending</option>
            <option value="in-progress" selected>Dalam proses</option>
            <option value="completed">Selesai</option>
            <option value="cancelled">Dibatalkan</option>
          </select>
        </div>
        <div>
          <label>Catatan (opsional)</label>
          <textarea name="episodes[${epIndex}].stages[].notes" rows="2"></textarea>
        </div>

        <fieldset>
          <legend>File di Stage</legend>
          <div class="files"></div>
          <button type="button" class="addFileBtn">+ Tambah File</button>
        </fieldset>
        <div style="text-align:right">
          <button type="button" class="removeStageBtn">Hapus Stage</button>
        </div>
      `;

      const filesContainer = stage.querySelector('.files');
      const addFileBtn = stage.querySelector('.addFileBtn');
      addFileBtn.addEventListener('click', () => {
        const fileDiv = document.createElement('div');
        fileDiv.className = 'file';
        fileDiv.style.border = '1px dotted #ddd';
        fileDiv.style.padding = '8px';
        fileDiv.style.margin = '8px 0';
        fileDiv.innerHTML = `
          <div class="row">
            <div>
              <label>File ID / Referensi</label>
              <input name="episodes[${epIndex}].stages[].files[].fileId" value="FILE${Date.now()}" required />
            </div>
            <div>
              <label>Jenis File (opsional)</label>
              <input name="episodes[${epIndex}].stages[].files[].fileType" value="application/pdf" />
            </div>
          </div>
          <div>
            <label>Unggah File (pdf, jpg, png, dcm)</label>
            <input type="file" class="fileUpload" accept=".pdf,.jpg,.jpeg,.png,.dcm" />
            <small class="fileHint" style="color:#64748b">File akan dikonversi ke base64 dan disimpan ke database.</small>
          </div>
          <div class="row">
            <div>
              <label>Ukuran (opsional)</label>
              <input name="episodes[${epIndex}].stages[].files[].fileSize" value="" />
            </div>
            <div>
              <label>Deskripsi (opsional)</label>
              <input name="episodes[${epIndex}].stages[].files[].metadata.description" value="Hasil pemeriksaan" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>Tag (koma dipisah, opsional)</label>
              <input name="episodes[${epIndex}].stages[].files[].metadata.tags" value="lab, hasil" />
            </div>
            <div>
              <label>Diunggah oleh (opsional)</label>
              <input name="episodes[${epIndex}].stages[].files[].metadata.uploadedBy" value="Admin" />
            </div>
          </div>
          <div style="text-align:right">
            <button type="button" class="removeFileBtn">Hapus File</button>
          </div>
        `;
        // Show selected file info in size/type
        const uploadInput = fileDiv.querySelector('.fileUpload');
        const sizeInput = fileDiv.querySelector(`input[name="episodes[${epIndex}].stages[].files[].fileSize"]`);
        const typeInput = fileDiv.querySelector(`input[name="episodes[${epIndex}].stages[].files[].fileType"]`);
        uploadInput.addEventListener('change', () => {
          const f = uploadInput.files?.[0];
          if (f) {
            sizeInput.value = String(f.size);
            typeInput.value = f.type || (f.name.endsWith('.dcm') ? 'application/dicom' : '');
          }
        });
        fileDiv.querySelector('.removeFileBtn').addEventListener('click', () => fileDiv.remove());
        filesContainer.appendChild(fileDiv);
      });

      stage.querySelector('.removeStageBtn').addEventListener('click', () => stage.remove());
      return stage;
    }

    function createEpisodeElement(epIndex) {
      const episode = document.createElement('fieldset');
      episode.className = 'episode';
      episode.style.border = '1px solid #bbb';
      episode.style.margin = '12px 0';
      episode.style.padding = '12px';
      episode.innerHTML = `
        <legend>Episode #${epIndex + 1}</legend>
        <div class="row">
          <div>
            <label>Episode ID</label>
            <input name="episodes[${epIndex}].episodeId" value="EP${String(epIndex + 1).padStart(3, '0')}" required />
          </div>
          <div>
            <label>Tanggal (YYYY-MM-DD)</label>
            <input name="episodes[${epIndex}].date" type="date" value="${new Date().toISOString().split('T')[0]}" required />
          </div>
        </div>
        <div class="row">
          <div>
            <label>Diagnosis</label>
            <input name="episodes[${epIndex}].diagnosis" value="Pemeriksaan Rutin" required />
          </div>
          <div>
            <label>Dokter Penanggung Jawab</label>
            <input name="episodes[${epIndex}].doctor" value="Dr. Ahmad Hidayat, Sp.PD" required />
          </div>
        </div>

        <fieldset>
          <legend>Stages</legend>
          <div class="stages"></div>
          <button type="button" class="addStageBtn">+ Tambah Stage</button>
        </fieldset>
        <div style="text-align:right">
          <button type="button" class="removeEpisodeBtn">Hapus Episode</button>
        </div>
      `;

      const stagesContainer = episode.querySelector('.stages');
      const addStageBtn = episode.querySelector('.addStageBtn');
      addStageBtn.addEventListener('click', () => stagesContainer.appendChild(createStageElement(epIndex)));
      episode.querySelector('.removeEpisodeBtn').addEventListener('click', () => episode.remove());

      // Tambah satu stage awal untuk kenyamanan
      stagesContainer.appendChild(createStageElement(epIndex));
      return episode;
    }

    addEpisodeBtn.addEventListener('click', () => {
      const epIndex = episodesContainer.querySelectorAll('.episode').length;
      episodesContainer.appendChild(createEpisodeElement(epIndex));
    });

    // Buat satu episode awal
    episodesContainer.appendChild(createEpisodeElement(0));

    async function serializeFormToPatient() {
      const base = {
        name: document.getElementById('name').value.trim(),
        patientId: document.getElementById('patientId').value.trim(),
        birthDate: document.getElementById('birthDate').value.trim(),
        gender: document.getElementById('gender').value,
        phone: document.getElementById('phone').value.trim(),
        email: document.getElementById('email').value.trim() || undefined,
        address: document.getElementById('address').value.trim() || undefined,
      };

      const ecName = document.getElementById('emergencyContactName').value.trim();
      const ecPhone = document.getElementById('emergencyContactPhone').value.trim();
      const ecRel = document.getElementById('emergencyContactRelationship').value.trim();
      const emergencyContact = (ecName || ecPhone || ecRel)
        ? { name: ecName, phone: ecPhone, relationship: ecRel }
        : undefined;

      const episodes = await Promise.all(
        Array.from(episodesContainer.querySelectorAll('.episode')).map(async (episodeEl, epIndex) => {
          const getInput = (name) => episodeEl.querySelector(`input[name="episodes[${epIndex}].${name}"]`);
          const episodeId = getInput('episodeId').value.trim();
          const date = getInput('date').value.trim();
          const diagnosis = getInput('diagnosis').value.trim();
          const doctor = getInput('doctor').value.trim();

          const stages = await Promise.all(
            Array.from(episodeEl.querySelectorAll('.stage')).map(async (stageEl) => {
              const q = (sel) => stageEl.querySelector(sel);
              const name = q(`input[name="episodes[${epIndex}].stages[].name"]`).value.trim();
              const date = q(`input[name="episodes[${epIndex}].stages[].date"]`).value.trim();
              const time = q(`input[name="episodes[${epIndex}].stages[].time"]`).value.trim();
              const ward = q(`input[name="episodes[${epIndex}].stages[].ward"]`).value.trim();
              const status = q(`select[name="episodes[${epIndex}].stages[].status"]`).value;
              const notesEl = q(`textarea[name="episodes[${epIndex}].stages[].notes"]`);
              const notes = notesEl && notesEl.value.trim() ? notesEl.value.trim() : undefined;

              const files = await Promise.all(
                Array.from(stageEl.querySelectorAll('.file')).map(async (fileEl) => {
                  const fq = (name) => fileEl.querySelector(`input[name="episodes[${epIndex}].stages[].files[].${name}"]`);
                  const fileId = fq('fileId').value.trim();
                  const fileType = fq('fileType').value.trim();
                  const fileSize = fq('fileSize').value.trim();
                  const desc = fileEl.querySelector(`input[name="episodes[${epIndex}].stages[].files[].metadata.description"]`).value.trim();
                  const tagsRaw = fileEl.querySelector(`input[name="episodes[${epIndex}].stages[].files[].metadata.tags"]`).value.trim();
                  const uploadedBy = fileEl.querySelector(`input[name="episodes[${epIndex}].stages[].files[].metadata.uploadedBy"]`).value.trim();
                  const uploadInput = fileEl.querySelector('.fileUpload');
                  const uploadedFile = uploadInput && uploadInput.files && uploadInput.files[0];

                  const metadata = (desc || tagsRaw || uploadedBy)
                    ? {
                        description: desc || undefined,
                        tags: tagsRaw ? tagsRaw.split(',').map(t => t.trim()).filter(Boolean) : undefined,
                        uploadedBy: uploadedBy || undefined,
                      }
                    : undefined;

                  const fileObj = {
                    fileId,
                    fileType: fileType || undefined,
                    fileSize: fileSize || undefined,
                    metadata,
                  };
                  
                  // Convert file to base64 if uploaded
                  if (uploadedFile) {
                    try {
                      const base64Data = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = () => {
                          const result = reader.result;
                          if (typeof result === 'string') {
                            const base64 = result.split(',')[1];
                            resolve(base64);
                          } else {
                            reject(new Error('Failed to read file'));
                          }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(uploadedFile);
                      });

                      fileObj.binaryData = {
                        base64: base64Data,
                        contentType: uploadedFile.type || 'application/octet-stream',
                        fileName: uploadedFile.name,
                      };
                    } catch (err) {
                      console.error('Error reading file:', err);
                    }
                  }
                  
                  return fileObj;
                })
              );

              return { name, date, time, ward, status, notes, files };
            })
          );

          return {
            episodeId,
            date,
            diagnosis,
            doctor,
            stages,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
          };
        })
      );

      return {
        ...base,
        emergencyContact,
        episodes,
      };
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      message.textContent = '';
      message.className = '';
      
      try {
        message.textContent = 'Memproses data dan file...';
        message.className = 'success';
        
        const payload = await serializeFormToPatient();

        const res = await fetch('/patients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          message.textContent = 'Berhasil menyimpan pasien: ' + (data.patient?.name || payload.name);
          message.className = 'success';
          form.reset();
          episodesContainer.innerHTML = '';
          episodesContainer.appendChild(createEpisodeElement(0));
        } else {
          message.textContent = data.error || 'Gagal menyimpan data';
          message.className = 'error';
        }
      } catch (err) {
        message.textContent = err.message || 'Kesalahan jaringan';
        message.className = 'error';
      }
    });
  </script>
  <script>
    const root = document.documentElement;
    const toggle = document.getElementById('themeToggle');
    const saved = localStorage.getItem('theme');
    if (saved === 'dark') { root.classList.add('dark'); toggle.textContent = 'Tema: Gelap'; }
    toggle.addEventListener('click', () => {
      root.classList.toggle('dark');
      const isDark = root.classList.contains('dark');
      toggle.textContent = isDark ? 'Tema: Gelap' : 'Tema: Cerah';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    });
  </script>
</body>
</html>
